<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poker Manager - Pro Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        poker: {
                            bg: '#0f172a',       // Slate 900
                            surface: '#1e293b',  // Slate 800
                            accent: '#10b981',   // Emerald 500
                            gold: '#fbbf24',     // Amber 400
                            danger: '#ef4444',   // Red 500
                            blue: '#3b82f6',     // Blue 500
                        }
                    },
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Courier New", 'monospace'],
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', "Segoe UI", 'Roboto', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15)',
                        'inner-light': 'inset 0 1px 0 0 rgba(255, 255, 255, 0.05)',
                    },
                    zIndex: {
                        '60': '60',
                    }
                }
            }
        }
    </script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body {
            background-color: #0f172a;
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 70%);
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            overscroll-behavior-y: none;
        }

        /* Glass Effect Panel */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .glass-header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Player Card Logic */
        .player-card {
            transition: opacity 0.3s ease, transform 0.2s ease;
        }
        /* Eliminiamo hover che cambiano colore di sfondo per stabilit√† */
        .player-card:active {
            transform: scale(0.99);
        }

        /* Progress Bar */
        .progress-fill {
            transition: width 1s linear;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.3);
        }

        /* Button Interactions */
        .btn-icon {
            transition: all 0.2s;
        }
        .btn-icon:active {
            transform: scale(0.9);
            background-color: rgba(255,255,255,0.1);
        }

        /* Rebuy Stepper Buttons */
        .btn-stepper {
            width: 28px; 
            height: 28px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 6px;
            background: rgba(0,0,0,0.2);
            color: #94a3b8;
            transition: background 0.2s, color 0.2s;
        }
        .btn-stepper:active {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        /* Dialog Animation */
        dialog[open] {
            animation: fadeSlideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
        }

        /* Chip Row */
        .chip-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .chip-row:last-child { border-bottom: none; }
    </style>
</head>
<body class="flex flex-col pb-36">

    <!-- === HEADER === -->
    <header class="sticky top-0 z-40 glass-header shadow-soft">
        <div class="max-w-lg mx-auto px-5 py-3 flex justify-between items-center">
            <div>
                <div class="text-[10px] text-slate-400 font-bold tracking-widest uppercase mb-0.5">MONTEPREMI</div>
                <div class="text-3xl font-bold text-poker-gold flex items-center gap-2 font-mono leading-none">
                    <i class="ph-fill ph-coins text-yellow-500"></i>
                    <span id="totalPotDisplay">‚Ç¨ 0</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="app.resetData()" class="w-10 h-10 rounded-full bg-slate-800/50 border border-slate-700 text-slate-400 hover:text-red-400 btn-icon flex items-center justify-center">
                    <i class="ph-bold ph-trash text-lg"></i>
                </button>
                <button onclick="ui.openSettings()" class="w-10 h-10 rounded-full bg-slate-800/50 border border-slate-700 text-slate-400 hover:text-white btn-icon flex items-center justify-center">
                    <i class="ph-bold ph-gear text-lg"></i>
                </button>
            </div>
        </div>
        
        <!-- Payout Bar -->
        <div class="max-w-lg mx-auto px-5 pb-2 flex justify-between text-xs border-t border-slate-800/50 pt-2">
            <div class="flex gap-4">
                <span class="text-slate-400">1¬∞ <span id="payout1" class="text-poker-accent font-bold font-mono text-sm">‚Ç¨0</span></span>
                <span class="text-slate-400">2¬∞ <span id="payout2" class="text-poker-blue font-bold font-mono text-sm">‚Ç¨0</span></span>
            </div>
            <span class="text-slate-500 font-mono">BUY-IN: <span id="buyinDisplay" class="text-slate-300">‚Ç¨0</span></span>
        </div>
    </header>

    <!-- === MAIN CONTENT === -->
    <main class="flex-grow w-full max-w-lg mx-auto px-4 pt-5 space-y-6">

        <!-- TIMER CARD -->
        <div id="timerCard" class="glass-panel rounded-3xl p-6 relative overflow-hidden shadow-soft">
            <!-- Blinds -->
            <div class="flex justify-between items-end relative z-10 mb-2">
                <div>
                    <span id="levelName" class="text-poker-blue text-[10px] font-bold tracking-widest uppercase bg-poker-blue/10 px-2 py-0.5 rounded mb-1 inline-block">Livello 1</span>
                    <div class="flex items-baseline gap-2">
                        <span id="blindsSmall" class="text-3xl font-bold text-white tracking-tight">100</span>
                        <span class="text-xl text-slate-600 font-light">/</span>
                        <span id="blindsBig" class="text-3xl font-bold text-white tracking-tight">200</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider mb-1">NEXT</div>
                    <div id="nextBlinds" class="text-slate-400 font-mono text-sm">200/400</div>
                </div>
            </div>

            <!-- Timer Big -->
            <div class="py-5 text-center relative z-10">
                <div id="timerDisplay" class="text-[5rem] leading-none font-mono font-bold text-white tracking-tighter tabular-nums drop-shadow-lg">
                    15:00
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden mb-6 relative z-10">
                <div id="timerProgress" class="progress-fill h-full w-full rounded-full"></div>
            </div>

            <!-- Controls -->
            <div class="grid grid-cols-3 gap-3 relative z-10">
                <button onclick="timer.prev()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl py-3 flex justify-center items-center btn-icon border border-slate-700/50">
                    <i class="ph-bold ph-skip-back text-xl"></i>
                </button>
                
                <button id="btnToggle" onclick="timer.toggle()" class="bg-poker-accent text-slate-900 font-bold rounded-xl py-3 flex justify-center items-center gap-2 btn-icon shadow-lg shadow-emerald-900/20 relative overflow-hidden">
                    <i id="iconPlay" class="ph-fill ph-play text-xl"></i>
                    <span id="textPlay" class="tracking-wide text-sm">START</span>
                </button>

                <button onclick="timer.next()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl py-3 flex justify-center items-center btn-icon border border-slate-700/50">
                    <i class="ph-bold ph-skip-forward text-xl"></i>
                </button>
            </div>

            <!-- Strategy Tip -->
            <div class="mt-4 pt-3 border-t border-slate-700/50 relative z-10">
                <div class="flex items-start gap-2">
                    <i class="ph-fill ph-lightbulb text-poker-gold mt-0.5"></i>
                    <p id="strategyText" class="text-xs text-slate-400 leading-relaxed italic">
                        Caricamento strategia...
                    </p>
                </div>
            </div>
        </div>

        <!-- PLAYERS SECTION -->
        <div>
            <div class="flex justify-between items-center mb-3 px-1">
                <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                    Giocatori <span id="playerCount" class="bg-slate-800 text-[10px] px-2 py-0.5 rounded-full text-slate-300 border border-slate-700">0</span>
                </h2>
                <div class="text-[10px] text-slate-500 font-mono">
                    TOTALE REBUY: <span id="totalRebuys" class="text-poker-danger font-bold text-xs">0</span>
                </div>
            </div>

            <div id="playersList" class="space-y-3 relative pb-6">
                <!-- Player Cards Injected Here -->
                <div class="text-center py-10 text-slate-600 border-2 border-dashed border-slate-800 rounded-2xl">
                    <i class="ph-duotone ph-users-three text-3xl mb-2 opacity-50"></i>
                    <p class="text-sm">Tavolo vuoto</p>
                </div>
            </div>
        </div>

        <!-- FOOTER STACK INFO -->
        <div class="bg-poker-surface rounded-2xl p-5 border border-slate-700/50 shadow-soft">
            <div class="text-center text-poker-blue font-bold border-b border-slate-700/50 pb-2 mb-2 tracking-widest text-xs uppercase">
                üü¶ Stack Iniziale ‚Äî 30.000
            </div>
            <div class="space-y-1 font-mono text-xs text-slate-400">
                <div class="chip-row"><span>10 √ó 100</span><span class="text-white font-bold">1.000</span></div>
                <div class="chip-row"><span>8 √ó 500</span><span class="text-white font-bold">4.000</span></div>
                <div class="chip-row"><span>10 √ó 1.000</span><span class="text-white font-bold">10.000</span></div>
                <div class="chip-row"><span>3 √ó 5.000</span><span class="text-white font-bold">15.000</span></div>
                <div class="flex justify-between items-center pt-2 mt-1 border-t border-slate-700 text-poker-gold font-bold text-sm">
                    <span>TOTALE</span><span>30.000</span>
                </div>
            </div>
        </div>

        <div class="text-center text-[10px] text-slate-600 pt-2">
            POKER MANAGER PRO ¬© 2025
        </div>

    </main>

    <!-- FAB (Add Player) -->
    <button onclick="ui.openAddPlayer()" class="fixed bottom-6 right-6 w-14 h-14 rounded-2xl bg-poker-blue text-white shadow-lg shadow-blue-900/40 flex items-center justify-center btn-icon z-50 border border-white/10">
        <i class="ph-bold ph-plus text-2xl"></i>
    </button>


    <!-- === MODALS === -->

    <!-- Settings Modal -->
    <dialog id="settingsModal" class="bg-transparent p-0 w-full max-w-sm m-auto backdrop:backdrop-blur-sm">
        <div class="glass-panel rounded-2xl p-6 shadow-2xl border border-slate-600/50 text-white">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold flex items-center gap-2 text-slate-200">Impostazioni</h3>
                <button onclick="ui.closeSettings()" class="text-slate-400 hover:text-white p-1"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold mb-2 block">Buy-in (‚Ç¨)</label>
                    <div class="flex items-center bg-slate-900/50 rounded-xl p-1 border border-slate-700">
                        <button onclick="adjustValue('buyin', -5)" class="w-10 h-10 rounded-lg bg-slate-800 hover:bg-slate-700 text-white font-bold">-</button>
                        <input type="number" id="settingBuyin" class="flex-1 bg-transparent text-center font-mono font-bold text-lg outline-none" value="30">
                        <button onclick="adjustValue('buyin', 5)" class="w-10 h-10 rounded-lg bg-slate-800 hover:bg-slate-700 text-white font-bold">+</button>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold mb-2 block">Rebuy Cost (‚Ç¨)</label>
                    <div class="flex items-center bg-slate-900/50 rounded-xl p-1 border border-slate-700">
                        <button onclick="adjustValue('rebuy', -5)" class="w-10 h-10 rounded-lg bg-slate-800 hover:bg-slate-700 text-white font-bold">-</button>
                        <input type="number" id="settingRebuy" class="flex-1 bg-transparent text-center font-mono font-bold text-lg outline-none" value="30">
                        <button onclick="adjustValue('rebuy', 5)" class="w-10 h-10 rounded-lg bg-slate-800 hover:bg-slate-700 text-white font-bold">+</button>
                    </div>
                </div>
            </div>

            <button onclick="app.saveSettings()" class="w-full mt-8 bg-poker-accent text-slate-900 font-bold py-3.5 rounded-xl btn-icon">
                SALVA E CHIUDI
            </button>
        </div>
    </dialog>

    <!-- Player Edit/Add Modal -->
    <dialog id="playerModal" class="bg-transparent p-0 w-full max-w-sm m-auto backdrop:backdrop-blur-sm">
        <div class="glass-panel rounded-2xl p-6 shadow-2xl border border-slate-600/50 text-white">
            <h3 id="modalTitle" class="text-lg font-bold mb-6 text-slate-200">Gestione Giocatore</h3>
            <input type="hidden" id="editPlayerIndex">
            
            <div class="space-y-5">
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold block mb-2">Nome</label>
                    <input type="text" id="inputName" placeholder="Es. Marco" class="w-full bg-slate-900/80 border border-slate-700 rounded-xl py-3 px-4 text-white focus:border-poker-blue outline-none transition-all">
                </div>

                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold block mb-2">Stile / Ruolo</label>
                    <div class="relative">
                        <select id="inputRole" class="w-full bg-slate-900/80 border border-slate-700 rounded-xl py-3 px-4 text-white appearance-none outline-none">
                            <optgroup label="REGULARS">
                                <option value="TAG">üéØ TAG (Solido)</option>
                                <option value="LAG">üöÄ LAG (Aggressivo)</option>
                                <option value="Nit">üßä Nit (Chiuso)</option>
                                <option value="ABC Player">üìò ABC Standard</option>
                            </optgroup>
                            <optgroup label="RECREATIONAL">
                                <option value="Aggro Whale">üê≥üî• Aggro Whale</option>
                                <option value="Calling Station">‚òéÔ∏è Calling Station</option>
                                <option value="Maniac">ü§° Maniac</option>
                                <option value="Gambler">üé≤ Gambler</option>
                                <option value="Passive Fish">üêü Passive Fish</option>
                            </optgroup>
                        </select>
                        <i class="ph-bold ph-caret-down absolute right-4 top-3.5 text-slate-500 pointer-events-none"></i>
                    </div>
                </div>

                <label class="flex items-center gap-3 p-3 bg-slate-800/50 rounded-xl border border-slate-700 cursor-pointer hover:bg-slate-800 transition">
                    <input type="checkbox" id="inputIsMe" class="w-5 h-5 rounded accent-poker-blue bg-slate-700 border-slate-600">
                    <span class="text-sm text-slate-300">Questo giocatore sono io</span>
                </label>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-8">
                <button onclick="ui.closePlayerModal()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 rounded-xl font-bold btn-icon">Annulla</button>
                <button onclick="app.savePlayer()" class="bg-poker-blue hover:bg-blue-600 text-white py-3 rounded-xl font-bold btn-icon">Salva</button>
            </div>
        </div>
    </dialog>


    <!-- === JAVASCRIPT === -->
    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            storageKey: 'poker_manager_pro_v1',
            blinds: [
                { sb: 100, bb: 200, time: 15, note: "Deep Stack. Gioca pulito." },
                { sb: 200, bb: 400, time: 15, note: "Isola i limper in posizione." },
                { sb: 300, bb: 600, time: 15, note: "Ruba i bui se sono tight." },
                { sb: 400, bb: 800, time: 15, note: "Attenzione agli stack < 20bb." },
                { sb: "BREAK", bb: "CHIP RACE", time: 10, note: "Pausa tecnica. Via le chips da 100." },
                { sb: 500, bb: 1000, time: 15, note: "Rebuy terminati. Freezeout." },
                { sb: 800, bb: 1600, time: 15, note: "Gioco solido, niente coinflip." },
                { sb: 1000, bb: 2000, time: 12, note: "Aggredisci la bolla." },
                { sb: 1500, bb: 3000, time: 12, note: "Push/Fold per gli short." },
                { sb: 2000, bb: 4000, time: 12, note: "Final Table." },
                { sb: 5000, bb: 10000, time: 10, note: "Heads Up." }
            ],
            // Define roles with stable colors (no strange gradients)
            roles: {
                "TAG": { icon: "üéØ", bg: "bg-emerald-900/30", border: "border-emerald-500/30" },
                "LAG": { icon: "üöÄ", bg: "bg-cyan-900/30", border: "border-cyan-500/30" },
                "Nit": { icon: "üßä", bg: "bg-blue-900/20", border: "border-blue-400/20" },
                "Aggro Whale": { icon: "üê≥", bg: "bg-red-900/30", border: "border-red-500/30" },
                "Calling Station": { icon: "‚òéÔ∏è", bg: "bg-yellow-900/20", border: "border-yellow-500/30" },
                "Maniac": { icon: "ü§°", bg: "bg-purple-900/30", border: "border-purple-500/30" },
                "Gambler": { icon: "üé≤", bg: "bg-orange-900/30", border: "border-orange-500/30" },
                "Passive Fish": { icon: "üêü", bg: "bg-indigo-900/20", border: "border-indigo-500/30" },
                "ABC Player": { icon: "üìò", bg: "bg-blue-800/30", border: "border-blue-600/30" }
            }
        };

        let state = {
            players: [],
            levelIndex: 0,
            timeRemaining: CONFIG.blinds[0].time * 60,
            timerRunning: false,
            settings: { buyin: 30, rebuy: 30 }
        };

        let timerInterval = null;
        let audioCtx = null;

        // --- AUDIO ---
        const sound = {
            init: () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); },
            alarm: () => {
                sound.init();
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const t = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, t);
                osc.frequency.linearRampToValueAtTime(880, t + 0.1);
                osc.frequency.setValueAtTime(440, t + 0.2);
                
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.6);
                
                osc.start(t);
                osc.stop(t + 0.6);
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
        };

        // --- APP LOGIC ---
        const app = {
            init: () => {
                app.load();
                ui.render();
                timer.render();
                document.getElementById('settingBuyin').value = state.settings.buyin;
                document.getElementById('settingRebuy').value = state.settings.rebuy;
            },

            save: () => localStorage.setItem(CONFIG.storageKey, JSON.stringify(state)),
            
            load: () => {
                const data = localStorage.getItem(CONFIG.storageKey);
                if (data) {
                    state = { ...state, ...JSON.parse(data) };
                    state.timerRunning = false;
                }
            },

            resetData: () => {
                if(confirm("‚ö†Ô∏è Vuoi cancellare tutto il torneo?")) {
                    localStorage.removeItem(CONFIG.storageKey);
                    location.reload();
                }
            },

            // New Logic: Rebuy +/- directly from card
            updateRebuy: (idx, delta) => {
                const p = state.players[idx];
                if (p.rebuy + delta < 0) return; // Prevent negative
                p.rebuy += delta;
                app.save();
                ui.render();
            },

            toggleOut: (idx) => {
                state.players[idx].out = !state.players[idx].out;
                app.save();
                ui.render();
            },

            deletePlayer: (idx) => {
                if(confirm("Eliminare definitivamente questo giocatore?")) {
                    state.players.splice(idx, 1);
                    app.save();
                    ui.render();
                }
            },

            savePlayer: () => {
                const name = document.getElementById('inputName').value.trim();
                const role = document.getElementById('inputRole').value;
                const isMe = document.getElementById('inputIsMe').checked;
                const idx = document.getElementById('editPlayerIndex').value;

                if (!name) return;

                if (isMe) state.players.forEach(p => p.me = false);

                const pData = { name, role, me: isMe, rebuy: 0, out: false };

                if (idx === "") state.players.push(pData);
                else {
                    pData.rebuy = state.players[idx].rebuy;
                    pData.out = state.players[idx].out;
                    state.players[idx] = pData;
                }

                app.save();
                ui.closePlayerModal();
                ui.render();
            },

            saveSettings: () => {
                state.settings.buyin = parseInt(document.getElementById('settingBuyin').value) || 0;
                state.settings.rebuy = parseInt(document.getElementById('settingRebuy').value) || 0;
                app.save();
                ui.closeSettings();
                ui.render();
            }
        };

        // --- TIMER ---
        const timer = {
            toggle: () => {
                sound.init();
                if (state.timerRunning) timer.stop();
                else timer.start();
            },

            start: () => {
                state.timerRunning = true;
                ui.updateBtn();
                timerInterval = setInterval(() => {
                    if (state.timeRemaining > 0) {
                        state.timeRemaining--;
                        timer.render();
                        if(state.timeRemaining % 5 === 0) app.save();
                    } else {
                        timer.complete();
                    }
                }, 1000);
            },

            stop: () => {
                state.timerRunning = false;
                clearInterval(timerInterval);
                ui.updateBtn();
                app.save();
            },

            next: (auto = false) => {
                if (state.levelIndex < CONFIG.blinds.length - 1) {
                    state.levelIndex++;
                    state.timeRemaining = CONFIG.blinds[state.levelIndex].time * 60;
                    timer.render();
                    app.save();
                    if(auto) timer.start(); else timer.stop();
                }
            },

            prev: () => {
                if (state.levelIndex > 0) {
                    state.levelIndex--;
                    state.timeRemaining = CONFIG.blinds[state.levelIndex].time * 60;
                    timer.stop();
                    timer.render();
                    app.save();
                }
            },

            complete: () => {
                timer.stop();
                sound.alarm();
                setTimeout(() => timer.next(true), 2000);
            },

            render: () => {
                const lvl = CONFIG.blinds[state.levelIndex];
                const m = Math.floor(state.timeRemaining / 60).toString().padStart(2, '0');
                const s = (state.timeRemaining % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').innerText = `${m}:${s}`;
                
                const totalSec = lvl.time * 60;
                const pct = (state.timeRemaining / totalSec) * 100;
                document.getElementById('timerProgress').style.width = `${pct}%`;

                if (lvl.sb === "BREAK") {
                    document.getElementById('levelName').innerText = "PAUSA";
                    document.getElementById('levelName').className = "text-poker-gold text-[10px] font-bold tracking-widest uppercase bg-poker-gold/10 px-2 py-0.5 rounded mb-1 inline-block animate-pulse";
                    document.getElementById('blindsSmall').innerText = "‚òï";
                    document.getElementById('blindsBig').innerText = "";
                } else {
                    document.getElementById('levelName').innerText = `LIVELLO ${state.levelIndex + 1}`;
                    document.getElementById('levelName').className = "text-poker-blue text-[10px] font-bold tracking-widest uppercase bg-poker-blue/10 px-2 py-0.5 rounded mb-1 inline-block";
                    document.getElementById('blindsSmall').innerText = lvl.sb;
                    document.getElementById('blindsBig').innerText = lvl.bb;
                }

                document.getElementById('strategyText').innerText = lvl.note;

                if (state.levelIndex < CONFIG.blinds.length - 1) {
                    const n = CONFIG.blinds[state.levelIndex + 1];
                    document.getElementById('nextBlinds').innerText = n.sb === "BREAK" ? "Pausa" : `${n.sb}/${n.bb}`;
                } else {
                    document.getElementById('nextBlinds').innerText = "END";
                }
            }
        };

        // --- UI ---
        const ui = {
            updateBtn: () => {
                const btn = document.getElementById('btnToggle');
                const icon = document.getElementById('iconPlay');
                const txt = document.getElementById('textPlay');
                
                if (state.timerRunning) {
                    btn.className = "bg-poker-gold text-black font-bold rounded-xl py-3 flex justify-center items-center gap-2 btn-icon shadow-lg shadow-yellow-900/20";
                    icon.className = "ph-fill ph-pause text-xl";
                    txt.innerText = "PAUSA";
                } else {
                    btn.className = "bg-poker-accent text-slate-900 font-bold rounded-xl py-3 flex justify-center items-center gap-2 btn-icon shadow-lg shadow-emerald-900/20 relative overflow-hidden";
                    icon.className = "ph-fill ph-play text-xl";
                    txt.innerText = "START";
                }
            },

            render: () => {
                // Calcoli Pot
                let pot = 0;
                let totRebuys = 0;
                state.players.forEach(p => {
                    pot += state.settings.buyin + (p.rebuy * state.settings.rebuy);
                    totRebuys += p.rebuy;
                });

                document.getElementById('totalPotDisplay').innerText = `‚Ç¨ ${pot}`;
                document.getElementById('totalRebuys').innerText = totRebuys;
                document.getElementById('buyinDisplay').innerText = `‚Ç¨${state.settings.buyin}`;
                
                const p1 = Math.round(pot * 0.7);
                document.getElementById('payout1').innerText = `‚Ç¨${p1}`;
                document.getElementById('payout2').innerText = `‚Ç¨${pot - p1}`;

                // Players List
                const list = document.getElementById('playersList');
                list.innerHTML = '';
                document.getElementById('playerCount').innerText = state.players.length;

                if (state.players.length === 0) {
                    list.innerHTML = `<div class="text-center py-10 text-slate-600 border-2 border-dashed border-slate-800 rounded-2xl"><i class="ph-duotone ph-users-three text-3xl mb-2 opacity-50"></i><p class="text-sm">Tavolo vuoto</p></div>`;
                    return;
                }

                state.players.forEach((p, i) => {
                    const role = CONFIG.roles[p.role] || CONFIG.roles["ABC Player"];
                    const isOut = p.out;
                    
                    const el = document.createElement('div');
                    el.id = `player-card-${i}`;
                    // Stable classes (no strange hover bg changes)
                    el.className = `player-card relative rounded-xl p-3 border backdrop-blur-md flex items-center justify-between gap-3 ${isOut ? 'bg-slate-900/80 border-slate-800 opacity-50 grayscale' : `${role.bg} ${role.border}`}`;
                    
                    if (p.me) el.classList.add('ring-1', 'ring-poker-blue', 'shadow-lg', 'shadow-blue-900/20');

                    el.innerHTML = `
                        <!-- Left: Info -->
                        <div class="flex items-center gap-3 min-w-0 relative z-10">
                            <div class="w-10 h-10 rounded-full bg-black/20 flex items-center justify-center text-2xl shadow-inner border border-white/5 shrink-0">
                                ${role.icon}
                            </div>
                            <div class="min-w-0">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-bold text-white truncate text-sm leading-tight ${isOut ? 'line-through text-slate-500' : ''}">${p.name}</h4>
                                    ${isOut ? '<span class="text-[9px] font-bold text-red-500 border border-red-500 px-1 rounded bg-red-500/10">OUT</span>' : ''}
                                </div>
                                <p class="text-[10px] text-slate-400 truncate mt-0.5 font-medium tracking-wide opacity-80">${p.role}</p>
                            </div>
                        </div>

                        <!-- Right: Controls -->
                        <div class="flex items-center gap-3 relative z-10">
                            
                            <!-- Rebuy Control (Visible) -->
                            <div class="flex items-center bg-slate-900/40 rounded-lg p-1 border border-slate-700/50 gap-2">
                                <button onclick="app.updateRebuy(${i}, -1)" class="btn-stepper hover:bg-white/10">
                                    <i class="ph-bold ph-minus text-xs"></i>
                                </button>
                                <div class="flex flex-col items-center w-4">
                                    <span class="text-[8px] text-slate-500 uppercase leading-none mb-0.5">RB</span>
                                    <span class="font-mono font-bold text-xs text-poker-danger leading-none">${p.rebuy}</span>
                                </div>
                                <button onclick="app.updateRebuy(${i}, 1)" class="btn-stepper hover:bg-white/10">
                                    <i class="ph-bold ph-plus text-xs"></i>
                                </button>
                            </div>

                            <!-- Menu Toggle -->
                            <div class="relative">
                                <button onclick="ui.toggleMenu(${i})" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:text-white hover:bg-white/10 transition">
                                    <i class="ph-bold ph-dots-three-vertical text-lg"></i>
                                </button>
                                
                                <!-- Context Menu -->
                                <div id="menu-${i}" class="hidden absolute right-0 top-10 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl overflow-hidden flex-col min-w-[160px] z-[100]">
                                    <button onclick="ui.openEditPlayer(${i}); ui.toggleMenu(${i})" class="px-4 py-3 text-left text-xs font-bold hover:bg-slate-700 text-white flex items-center gap-2 border-b border-slate-700">
                                        <i class="ph-bold ph-pencil text-poker-blue"></i> MODIFICA
                                    </button>
                                    <button onclick="app.toggleOut(${i}); ui.toggleMenu(${i})" class="px-4 py-3 text-left text-xs font-bold hover:bg-slate-700 ${isOut ? 'text-poker-accent' : 'text-slate-300'} flex items-center gap-2 border-b border-slate-700">
                                        <i class="ph-bold ${isOut ? 'ph-arrow-u-up-left' : 'ph-skull'}"></i> ${isOut ? 'RIENTRA (IN)' : 'ELIMINA (OUT)'}
                                    </button>
                                    <button onclick="app.deletePlayer(${i}); ui.toggleMenu(${i})" class="px-4 py-3 text-left text-xs font-bold hover:bg-red-900/30 text-red-400 flex items-center gap-2">
                                        <i class="ph-bold ph-trash"></i> RIMUOVI
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(el);
                });
            },

            // Modal Helpers
            openAddPlayer: () => {
                document.getElementById('modalTitle').innerText = "Nuovo Giocatore";
                document.getElementById('inputName').value = "";
                document.getElementById('inputRole').value = "TAG";
                document.getElementById('inputIsMe').checked = false;
                document.getElementById('editPlayerIndex').value = "";
                document.getElementById('playerModal').showModal();
            },
            openEditPlayer: (i) => {
                const p = state.players[i];
                document.getElementById('modalTitle').innerText = "Modifica Giocatore";
                document.getElementById('inputName').value = p.name;
                document.getElementById('inputRole').value = p.role;
                document.getElementById('inputIsMe').checked = p.me;
                document.getElementById('editPlayerIndex').value = i;
                document.getElementById('playerModal').showModal();
            },
            closePlayerModal: () => document.getElementById('playerModal').close(),
            openSettings: () => document.getElementById('settingsModal').showModal(),
            closeSettings: () => document.getElementById('settingsModal').close(),
            
            // Z-Index fix for Menu
            toggleMenu: (i) => {
                const menu = document.getElementById(`menu-${i}`);
                const card = document.getElementById(`player-card-${i}`);
                const isHidden = menu.classList.contains('hidden');

                // Reset all
                document.querySelectorAll('[id^="menu-"]').forEach(m => m.classList.add('hidden'));
                document.querySelectorAll('[id^="player-card-"]').forEach(c => c.style.zIndex = "auto");

                if (isHidden) {
                    menu.classList.remove('hidden');
                    card.style.zIndex = "60"; // Bring to front
                } else {
                    menu.classList.add('hidden');
                    card.style.zIndex = "auto";
                }
            }
        };

        window.adjustValue = (type, v) => {
            const el = document.getElementById(type === 'buyin' ? 'settingBuyin' : 'settingRebuy');
            el.value = Math.max(0, parseInt(el.value) + v);
        };
        document.addEventListener('click', (e) => {
            // Close menu if clicking outside
            if(!e.target.closest('.ph-dots-three-vertical') && !e.target.closest('[id^="menu-"]')) {
                document.querySelectorAll('[id^="menu-"]').forEach(m => m.classList.add('hidden'));
                document.querySelectorAll('[id^="player-card-"]').forEach(c => c.style.zIndex = "auto");
            }
        });

        window.onload = app.init;
    </script>
</body>
</html>